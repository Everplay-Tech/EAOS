#!/bin/bash

set -e

echo "ðŸ§¬ Building EÃ¤ Nucleus System"

# Configuration
ROOT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
MUSCLES_DIR="$ROOT_DIR/muscles"
COMPILER_DIR="$ROOT_DIR/muscle-compiler"
BUNDLES_DIR="$ROOT_DIR/bundles"
TARGET_DIR="$ROOT_DIR/target"
TARGET="aarch64"
PRELOADER_TARGETS=("aarch64-unknown-uefi" "x86_64-unknown-uefi")

# Create bundles directory
mkdir -p "$BUNDLES_DIR"

echo "ðŸ”¨ Step 1: Building enhanced muscle compiler..."
cd "$COMPILER_DIR"
cargo build --release
cd "$ROOT_DIR"

echo "ðŸ”¨ Step 2: Compiling nucleus.ea to sealed blob..."
MUSCLEC_BIN="$TARGET_DIR/release/musclec"
if [ ! -x "$MUSCLEC_BIN" ]; then
    echo "âŒ musclec not found at $MUSCLEC_BIN"
    exit 1
fi
 "$MUSCLEC_BIN" \
    --input "$MUSCLES_DIR/nucleus.ea" \
    --target "$TARGET" \
    --output "$BUNDLES_DIR/nucleus.blob" \
    --chaos-master $(openssl rand -hex 32)

# Verify nucleus blob size
NUCLEUS_SIZE=$(stat -f%z "$BUNDLES_DIR/nucleus.blob" 2>/dev/null || stat -c%s "$BUNDLES_DIR/nucleus.blob")
if [ "$NUCLEUS_SIZE" -ne 8256 ]; then
    echo "âŒ Nucleus blob size incorrect: $NUCLEUS_SIZE bytes (expected 8256)"
    exit 1
fi
echo "âœ… Nucleus blob: $NUCLEUS_SIZE bytes"

echo "ðŸ” Step 2b: Pinning nucleus blob hash..."
NUCLEUS_HASH_HEX=$(cargo run --offline -q -p muscle-contract --bin hash-blob -- "$BUNDLES_DIR/nucleus.blob")
echo "âœ… Nucleus hash: $NUCLEUS_HASH_HEX"

echo "ðŸ”¨ Step 3: Building pre-nucleus loader (static blob)..."
cd "$MUSCLES_DIR/preloader"
for PRELOADER_TARGET in "${PRELOADER_TARGETS[@]}"; do
    echo "   - target: $PRELOADER_TARGET"
    EXPECTED_NUCLEUS_HASH_HEX=$NUCLEUS_HASH_HEX cargo build --offline --target "$PRELOADER_TARGET" --release
    PRELOADER_ARCHIVE="$TARGET_DIR/$PRELOADER_TARGET/release/libpreloader.a"
    if [ ! -f "$PRELOADER_ARCHIVE" ]; then
        echo "âŒ Pre-loader archive missing: $PRELOADER_ARCHIVE"
        exit 1
    fi
    PRELOADER_SIZE=$(stat -f%z "$PRELOADER_ARCHIVE" 2>/dev/null || stat -c%s "$PRELOADER_ARCHIVE")
    ARCH_TAG="${PRELOADER_TARGET%%-*}"
    cp "$PRELOADER_ARCHIVE" "$BUNDLES_DIR/preloader.${ARCH_TAG}.a"
    echo "âœ… Pre-loader archive: preloader.${ARCH_TAG}.a ($PRELOADER_SIZE bytes)"
done
cd "$ROOT_DIR"

echo "ðŸ”¨ Step 4: Creating boot bundle..."

echo "ðŸŽ‰ Nucleus build complete!"
echo "ðŸ“¦ Boot bundle created in $BUNDLES_DIR/:"
echo "   - preloader.a (static pre-nucleus loader blob, per-arch)"
echo "     - preloader.aarch64.a"
echo "     - preloader.x86_64.a"
echo "   - nucleus.blob (8.06KiB sealed muscle blob)"
