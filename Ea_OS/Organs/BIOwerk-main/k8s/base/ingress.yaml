# Ingress for BIOwerk with TLS and Rate Limiting
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: biowerk-ingress
  namespace: biowerk
  labels:
    app: biowerk
  annotations:
    # NGINX Ingress Controller annotations
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"

    # Rate limiting
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-burst-multiplier: "5"
    nginx.ingress.kubernetes.io/limit-connections: "50"

    # Security headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Frame-Options: DENY";
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";
      more_set_headers "Content-Security-Policy: default-src 'self'";
      more_set_headers "Strict-Transport-Security: max-age=31536000; includeSubDomains; preload";

    # CORS (if needed)
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization"

    # Client body size limit
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"

    # Timeouts
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"

    # Certificate Manager (cert-manager.io)
    cert-manager.io/cluster-issuer: "letsencrypt-prod"

    # Alternative: Use AWS Certificate Manager (ACM) with AWS Load Balancer Controller
    # alb.ingress.kubernetes.io/certificate-arn: "arn:aws:acm:region:account-id:certificate/certificate-id"
    # alb.ingress.kubernetes.io/ssl-policy: "ELBSecurityPolicy-TLS-1-2-2017-01"

spec:
  ingressClassName: nginx  # Use 'alb' for AWS Load Balancer Controller
  tls:
  - hosts:
    - biowerk.example.com  # Replace with your domain
    - api.biowerk.example.com
    secretName: biowerk-tls-cert
  rules:
  # Main application
  - host: biowerk.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: mesh
            port:
              number: 80

  # API endpoint
  - host: api.biowerk.example.com
    http:
      paths:
      # Main gateway
      - path: /
        pathType: Prefix
        backend:
          service:
            name: mesh
            port:
              number: 80

      # Direct access to services (optional, for debugging)
      - path: /osteon
        pathType: Prefix
        backend:
          service:
            name: osteon
            port:
              number: 8001

      - path: /myocyte
        pathType: Prefix
        backend:
          service:
            name: myocyte
            port:
              number: 8002

      - path: /synapse
        pathType: Prefix
        backend:
          service:
            name: synapse
            port:
              number: 8003

      - path: /circadian
        pathType: Prefix
        backend:
          service:
            name: circadian
            port:
              number: 8004

      - path: /nucleus
        pathType: Prefix
        backend:
          service:
            name: nucleus
            port:
              number: 8005

      - path: /chaperone
        pathType: Prefix
        backend:
          service:
            name: chaperone
            port:
              number: 8006

      - path: /gdpr
        pathType: Prefix
        backend:
          service:
            name: gdpr
            port:
              number: 8010

# Ingress for Monitoring/Observability (Internal Only)
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: biowerk-monitoring-ingress
  namespace: biowerk
  labels:
    app: biowerk-monitoring
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"

    # Basic authentication (create secret with htpasswd)
    nginx.ingress.kubernetes.io/auth-type: basic
    nginx.ingress.kubernetes.io/auth-secret: monitoring-basic-auth
    nginx.ingress.kubernetes.io/auth-realm: 'Authentication Required - BIOwerk Monitoring'

    # Whitelist internal IPs only (adjust to your VPN/office IP range)
    nginx.ingress.kubernetes.io/whitelist-source-range: "10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"

spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - monitoring.biowerk.example.com
    secretName: biowerk-monitoring-tls-cert
  rules:
  - host: monitoring.biowerk.example.com
    http:
      paths:
      # Grafana
      - path: /
        pathType: Prefix
        backend:
          service:
            name: grafana
            port:
              number: 3000

      # Prometheus
      - path: /prometheus
        pathType: Prefix
        backend:
          service:
            name: prometheus
            port:
              number: 9090

      # Alertmanager
      - path: /alertmanager
        pathType: Prefix
        backend:
          service:
            name: alertmanager
            port:
              number: 9093

---
# Note: To create basic auth secret for monitoring:
# htpasswd -c auth admin
# kubectl create secret generic monitoring-basic-auth --from-file=auth -n biowerk

# Note: For cert-manager, create a ClusterIssuer:
# apiVersion: cert-manager.io/v1
# kind: ClusterIssuer
# metadata:
#   name: letsencrypt-prod
# spec:
#   acme:
#     server: https://acme-v02.api.letsencrypt.org/directory
#     email: your-email@example.com
#     privateKeySecretRef:
#       name: letsencrypt-prod
#     solvers:
#     - http01:
#         ingress:
#           class: nginx
