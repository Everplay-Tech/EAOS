name: OWASP ZAP Security Testing

on:
  push:
    branches: ["main", "develop", "claude/**"]
  pull_request:
    branches: ["main", "develop"]
  schedule:
    # Run comprehensive security scan weekly on Sundays at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of scan to perform'
        required: true
        default: 'baseline'
        type: choice
        options:
          - baseline
          - full
          - api
      target:
        description: 'Target URL (leave empty for default)'
        required: false
        default: ''

env:
  PYTHON_VERSION: "3.11"
  ZAP_VERSION: "stable"
  TARGET_URL: "http://localhost:8080"

jobs:
  # ====================
  # OWASP ZAP Baseline Scan
  # ====================
  zap-baseline-scan:
    name: ZAP Baseline Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.event.inputs.scan_type == 'baseline' || github.event.inputs.scan_type == '' || github.event_name != 'workflow_dispatch'

    permissions:
      contents: read
      security-events: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set target URL
        id: set-target
        run: |
          if [ -n "${{ github.event.inputs.target }}" ]; then
            echo "target=${{ github.event.inputs.target }}" >> $GITHUB_OUTPUT
          else
            echo "target=${{ env.TARGET_URL }}" >> $GITHUB_OUTPUT
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Start services with Docker Compose
        run: |
          docker compose up -d postgres mongodb redis pgbouncer
          sleep 10

      - name: Build and start application services
        run: |
          docker compose build mesh osteon myocyte synapse circadian nucleus chaperone gdpr
          docker compose up -d
          sleep 20

      - name: Wait for services to be ready
        run: |
          timeout 120 bash -c 'until curl -sf http://localhost:8080/health; do sleep 3; done'
          echo "Services are ready"

      - name: Display service status
        run: |
          docker compose ps
          curl -s http://localhost:8080/health | jq .

      - name: Create ZAP configuration
        run: |
          mkdir -p zap-config
          cat > zap-config/baseline.conf <<EOF
          # ZAP Baseline Scan Configuration
          # Exclude paths that should not be scanned
          -config excludedpaths.excluded='.*logout.*'
          -config excludedpaths.excluded='.*delete.*'
          -config spider.maxDepth=5
          -config spider.maxChildren=10
          -config spider.postform=true
          -config spider.parseComments=true
          -config spider.parseRobotsTxt=true
          EOF

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: ${{ steps.set-target.outputs.target }}
          rules_file_name: 'zap-config/baseline.conf'
          cmd_options: '-a -j -m 5 -T 15'
          fail_action: false
          allow_issue_writing: true
          issue_title: 'OWASP ZAP Baseline Security Scan Report'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload ZAP baseline report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-baseline-report
          path: |
            report_html.html
            report_json.json
            report_md.md
          retention-days: 30

      - name: Generate SARIF report
        if: always()
        run: |
          # Convert ZAP JSON to SARIF format if available
          if [ -f "report_json.json" ]; then
            echo "ZAP baseline scan completed"
          fi

      - name: Cleanup
        if: always()
        run: docker compose down -v

  # ====================
  # OWASP ZAP API Scan
  # ====================
  zap-api-scan:
    name: ZAP API Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: github.event.inputs.scan_type == 'api' || github.event_name == 'workflow_dispatch'

    permissions:
      contents: read
      security-events: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Start services with Docker Compose
        run: |
          docker compose up -d postgres mongodb redis pgbouncer
          sleep 10

      - name: Build and start application services
        run: |
          docker compose build mesh osteon myocyte synapse circadian nucleus chaperone gdpr
          docker compose up -d
          sleep 20

      - name: Wait for services to be ready
        run: |
          timeout 120 bash -c 'until curl -sf http://localhost:8080/health; do sleep 3; done'
          echo "Services are ready"

      - name: Generate OpenAPI specification
        run: |
          mkdir -p zap-config
          # Fetch OpenAPI spec from the mesh service
          curl -s http://localhost:8080/openapi.json > zap-config/openapi.json || \
          curl -s http://localhost:8080/docs > zap-config/api-docs.html || \
          echo "OpenAPI spec not available, using generated config"

          # Create API scan configuration
          cat > zap-config/api-scan.conf <<EOF
          # ZAP API Scan Configuration
          -config replacer.full_list(0).enabled=true
          -config replacer.full_list(0).matchtype=REQ_HEADER
          -config replacer.full_list(0).matchstring=Accept
          -config replacer.full_list(0).replacement=application/json
          -config spider.maxDepth=10
          -config ascan.policy=API-Minimal
          EOF

      - name: OWASP ZAP API Scan
        uses: zaproxy/action-api-scan@v0.7.0
        with:
          target: 'http://localhost:8080'
          format: 'openapi'
          api_spec: 'zap-config/openapi.json'
          cmd_options: '-a -j -T 20'
          fail_action: false
          allow_issue_writing: true
          issue_title: 'OWASP ZAP API Security Scan Report'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload ZAP API scan report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-api-scan-report
          path: |
            report_html.html
            report_json.json
            report_md.md
          retention-days: 30

      - name: Cleanup
        if: always()
        run: docker compose down -v

  # ====================
  # OWASP ZAP Full Scan (Deep Testing)
  # ====================
  zap-full-scan:
    name: ZAP Full Security Scan (Deep)
    runs-on: ubuntu-latest
    timeout-minutes: 90
    if: github.event.inputs.scan_type == 'full' || github.event_name == 'schedule'

    permissions:
      contents: read
      security-events: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Start services with Docker Compose
        run: |
          docker compose up -d postgres mongodb redis pgbouncer
          sleep 10

      - name: Build and start application services
        run: |
          docker compose build mesh osteon myocyte synapse circadian nucleus chaperone gdpr
          docker compose up -d
          sleep 20

      - name: Wait for services to be ready
        run: |
          timeout 120 bash -c 'until curl -sf http://localhost:8080/health; do sleep 3; done'
          echo "Services are ready"

      - name: Create comprehensive ZAP configuration
        run: |
          mkdir -p zap-config
          cat > zap-config/full-scan.conf <<EOF
          # ZAP Full Scan Configuration - Enterprise Grade

          # Spider Configuration
          -config spider.maxDepth=10
          -config spider.maxChildren=20
          -config spider.postform=true
          -config spider.parseComments=true
          -config spider.parseRobotsTxt=true
          -config spider.parseSitemapXml=true
          -config spider.maxDuration=30

          # Active Scan Configuration
          -config ascan.policy=Default Policy
          -config ascan.strength=MEDIUM
          -config ascan.threadPerHost=5

          # Scan Rules
          -config rules.csrf.enabled=true
          -config rules.sqli.enabled=true
          -config rules.xss.enabled=true
          -config rules.pathtraversal.enabled=true
          -config rules.remotefileinclude.enabled=true
          -config rules.servererror.enabled=true
          -config rules.privateipdisclosure.enabled=true

          # Security Headers
          -config rules.securityheaders.enabled=true

          # Exclusions
          -config excludedpaths.excluded='.*logout.*'
          -config excludedpaths.excluded='.*delete.*'
          -config excludedpaths.excluded='.*admin/destroy.*'
          EOF

      - name: OWASP ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.10.0
        with:
          target: 'http://localhost:8080'
          rules_file_name: 'zap-config/full-scan.conf'
          cmd_options: '-a -j -m 10 -T 30'
          fail_action: false
          allow_issue_writing: true
          issue_title: 'OWASP ZAP Full Security Scan Report - Deep Analysis'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload ZAP full scan report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-full-scan-report
          path: |
            report_html.html
            report_json.json
            report_md.md
          retention-days: 90

      - name: Parse and analyze results
        if: always()
        run: |
          if [ -f "report_json.json" ]; then
            echo "## ZAP Full Scan Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Extract high-risk findings
            high_risk=$(jq -r '.site[0].alerts[] | select(.riskcode == "3") | .name' report_json.json 2>/dev/null | wc -l || echo "0")
            medium_risk=$(jq -r '.site[0].alerts[] | select(.riskcode == "2") | .name' report_json.json 2>/dev/null | wc -l || echo "0")
            low_risk=$(jq -r '.site[0].alerts[] | select(.riskcode == "1") | .name' report_json.json 2>/dev/null | wc -l || echo "0")

            echo "### Vulnerability Summary" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”´ High Risk: $high_risk" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ¡ Medium Risk: $medium_risk" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”µ Low Risk: $low_risk" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "$high_risk" -gt 0 ]; then
              echo "### âš ï¸ High Risk Vulnerabilities Found" >> $GITHUB_STEP_SUMMARY
              jq -r '.site[0].alerts[] | select(.riskcode == "3") | "- **\(.name)**: \(.desc)"' report_json.json >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
            fi
          fi

      - name: Cleanup
        if: always()
        run: docker compose down -v

  # ====================
  # Security Scan Summary
  # ====================
  security-summary:
    name: Security Testing Summary
    runs-on: ubuntu-latest
    needs: [zap-baseline-scan]
    if: always()

    steps:
      - name: Download all ZAP reports
        uses: actions/download-artifact@v4
        continue-on-error: true

      - name: Generate comprehensive security summary
        run: |
          echo "## OWASP ZAP Security Testing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Security scans completed for commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Baseline Scan: ${{ needs.zap-baseline-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Enterprise Security Best Practices" >> $GITHUB_STEP_SUMMARY
          echo "1. **Regular Scanning**: Security scans run on every push and weekly" >> $GITHUB_STEP_SUMMARY
          echo "2. **Multiple Scan Types**: Baseline, API, and Full scans for comprehensive coverage" >> $GITHUB_STEP_SUMMARY
          echo "3. **Automated Reporting**: Results automatically uploaded and tracked" >> $GITHUB_STEP_SUMMARY
          echo "4. **Continuous Monitoring**: Integration with GitHub Security tab" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review all security findings in the workflow artifacts" >> $GITHUB_STEP_SUMMARY
          echo "2. Address HIGH and CRITICAL vulnerabilities immediately" >> $GITHUB_STEP_SUMMARY
          echo "3. Create tickets for MEDIUM priority issues" >> $GITHUB_STEP_SUMMARY
          echo "4. Schedule remediation reviews with the security team" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "For detailed reports, check the workflow artifacts section." >> $GITHUB_STEP_SUMMARY
