#!/bin/bash
################################################################################
# BIOwerk Backup Configuration
#
# This file contains configuration for all backup operations.
# It is sourced by backup and restore scripts.
################################################################################

# ============================================================================
# General Backup Settings
# ============================================================================

# Backup base directory
export BACKUP_DIR="${BACKUP_DIR:-/var/backups/biowerk}"

# Backup retention policies (in days)
export BACKUP_RETENTION_DAYS="${BACKUP_RETENTION_DAYS:-30}"
export BACKUP_RETENTION_WEEKLY="${BACKUP_RETENTION_WEEKLY:-12}"  # weeks
export BACKUP_RETENTION_MONTHLY="${BACKUP_RETENTION_MONTHLY:-12}"  # months

# Compression method: gzip, zstd, or none
export COMPRESSION="${COMPRESSION:-zstd}"

# Encryption settings
export ENCRYPTION_ENABLED="${ENCRYPTION_ENABLED:-true}"
export ENCRYPTION_KEY_FILE="${ENCRYPTION_KEY_FILE:-/etc/biowerk/backup-encryption.key}"

# Verification
export VERIFY_BACKUP="${VERIFY_BACKUP:-true}"

# Parallel jobs for backup operations
export PARALLEL_JOBS="${PARALLEL_JOBS:-4}"

# Metrics output directory
export METRICS_FILE_DIR="${METRICS_FILE_DIR:-/var/lib/biowerk/metrics}"

# ============================================================================
# PostgreSQL Settings
# ============================================================================

export POSTGRES_HOST="${POSTGRES_HOST:-postgres}"
export POSTGRES_PORT="${POSTGRES_PORT:-5432}"
export POSTGRES_USER="${POSTGRES_USER:-biowerk}"
export POSTGRES_PASSWORD="${POSTGRES_PASSWORD:-biowerk_dev_password}"
export POSTGRES_DB="${POSTGRES_DB:-biowerk}"

# PostgreSQL-specific settings
export POSTGRES_BACKUP_ENABLED="${POSTGRES_BACKUP_ENABLED:-true}"
export POSTGRES_BACKUP_SCHEDULE="${POSTGRES_BACKUP_SCHEDULE:-0 2 * * *}"  # 2 AM daily
export POSTGRES_WAL_ARCHIVING="${POSTGRES_WAL_ARCHIVING:-false}"

# ============================================================================
# MongoDB Settings
# ============================================================================

export MONGODB_HOST="${MONGODB_HOST:-mongodb}"
export MONGODB_PORT="${MONGODB_PORT:-27017}"
export MONGODB_USER="${MONGODB_USER:-biowerk}"
export MONGODB_PASSWORD="${MONGODB_PASSWORD:-biowerk_dev_password}"
export MONGODB_DB="${MONGODB_DB:-biowerk}"
export MONGODB_AUTH_DB="${MONGODB_AUTH_DB:-admin}"

# MongoDB-specific settings
export MONGODB_BACKUP_ENABLED="${MONGODB_BACKUP_ENABLED:-true}"
export MONGODB_BACKUP_SCHEDULE="${MONGODB_BACKUP_SCHEDULE:-30 2 * * *}"  # 2:30 AM daily
export MONGODB_OPLOG_ENABLED="${MONGODB_OPLOG_ENABLED:-false}"

# ============================================================================
# Redis Settings
# ============================================================================

export REDIS_HOST="${REDIS_HOST:-redis}"
export REDIS_PORT="${REDIS_PORT:-6379}"
export REDIS_PASSWORD="${REDIS_PASSWORD:-}"
export REDIS_DATA_DIR="${REDIS_DATA_DIR:-/data}"

# Redis-specific settings
export REDIS_BACKUP_ENABLED="${REDIS_BACKUP_ENABLED:-true}"
export REDIS_BACKUP_SCHEDULE="${REDIS_BACKUP_SCHEDULE:-0 3 * * *}"  # 3 AM daily
export REDIS_BACKUP_METHOD="${REDIS_BACKUP_METHOD:-rdb}"  # rdb, aof, or both

# ============================================================================
# Cloud Storage Settings
# ============================================================================

# S3 / AWS
export S3_ENABLED="${S3_ENABLED:-false}"
export S3_BUCKET="${S3_BUCKET:-}"
export S3_REGION="${S3_REGION:-us-east-1}"
export S3_STORAGE_CLASS="${S3_STORAGE_CLASS:-STANDARD_IA}"
export AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID:-}"
export AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY:-}"

# Azure Blob Storage
export AZURE_ENABLED="${AZURE_ENABLED:-false}"
export AZURE_STORAGE_ACCOUNT="${AZURE_STORAGE_ACCOUNT:-}"
export AZURE_STORAGE_KEY="${AZURE_STORAGE_KEY:-}"
export AZURE_CONTAINER="${AZURE_CONTAINER:-biowerk-backups}"

# Google Cloud Storage
export GCS_ENABLED="${GCS_ENABLED:-false}"
export GCS_BUCKET="${GCS_BUCKET:-}"
export GCS_PROJECT="${GCS_PROJECT:-}"

# ============================================================================
# Disaster Recovery Settings
# ============================================================================

# Recovery Time Objective (RTO) - target time to restore
export RTO_TARGET="${RTO_TARGET:-4h}"

# Recovery Point Objective (RPO) - acceptable data loss
export RPO_TARGET="${RPO_TARGET:-1h}"

# DR testing schedule (cron format)
export DR_TEST_SCHEDULE="${DR_TEST_SCHEDULE:-0 4 * * 0}"  # 4 AM every Sunday

# DR test environment
export DR_TEST_ENABLED="${DR_TEST_ENABLED:-true}"
export DR_TEST_DATABASE_SUFFIX="${DR_TEST_DATABASE_SUFFIX:-_dr_test}"

# ============================================================================
# Alerting Settings
# ============================================================================

# Alert on backup failure
export ALERT_ON_FAILURE="${ALERT_ON_FAILURE:-true}"

# Alert if backup is older than threshold (in hours)
export ALERT_BACKUP_AGE_THRESHOLD="${ALERT_BACKUP_AGE_THRESHOLD:-25}"

# Alert destinations
export ALERT_EMAIL="${ALERT_EMAIL:-ops@example.com}"
export ALERT_SLACK_WEBHOOK="${ALERT_SLACK_WEBHOOK:-}"
export ALERT_PAGERDUTY_KEY="${ALERT_PAGERDUTY_KEY:-}"

# ============================================================================
# Logging Settings
# ============================================================================

export LOG_DIR="${LOG_DIR:-/var/log/biowerk}"
export LOG_LEVEL="${LOG_LEVEL:-INFO}"
export LOG_RETENTION_DAYS="${LOG_RETENTION_DAYS:-90}"
