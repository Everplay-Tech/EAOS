---
# Promtail configuration for BIOwerk microservices
# Collects logs from Docker containers and ships to Loki
server:
  http_listen_port: 9080
  grpc_listen_port: 0
  log_level: info

# Promtail positions file to track log reading progress
positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push
    batchwait: 1s
    batchsize: 1048576  # 1MB
    timeout: 10s
    backoff_config:
      min_period: 500ms
      max_period: 5m
      max_retries: 10
    # External labels added to all logs
    external_labels:
      cluster: biowerk
      environment: ${ENVIRONMENT:-development}

# Scrape configurations
scrape_configs:
  # Docker container logs scraping
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: label
            values: ["com.docker.compose.project=biowerk"]

    # Relabeling rules to extract metadata
    relabel_configs:
      # Extract container name
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: 'container_name'

      # Extract service name from compose
      - source_labels: ['__meta_docker_container_label_com_docker_compose_service']
        target_label: 'service'

      # Extract compose project
      - source_labels: ['__meta_docker_container_label_com_docker_compose_project']
        target_label: 'compose_project'

      # Add job label
      - target_label: 'job'
        replacement: 'docker'

      # Extract log path
      - source_labels: ['__meta_docker_container_log_stream']
        target_label: 'stream'

    # Pipeline stages for log processing
    pipeline_stages:
      # Parse JSON logs
      - json:
          expressions:
            timestamp: timestamp
            level: level
            logger: logger
            message: message
            service_name: service_name
            trace_id: trace_id
            span_id: span_id
            module: module
            function: function
            line: line
            exception_type: exception.type
            exception_message: exception.message

      # Use timestamp from log if available
      - timestamp:
          source: timestamp
          format: RFC3339Nano
          fallback_formats:
            - RFC3339
            - "2006-01-02T15:04:05.999999999Z07:00"

      # Extract log level
      - labels:
          level:
          service_name:
          trace_id:
          span_id:

      # Add metrics based on log content
      - metrics:
          # Count logs by level
          log_lines_total:
            type: Counter
            description: "Total number of log lines"
            source: level
            config:
              action: inc

          # Count errors
          log_errors_total:
            type: Counter
            description: "Total number of error logs"
            source: level
            config:
              match_all: true
              action: inc
            match_stage:
              selector: '{level="ERROR"}'

          # Count warnings
          log_warnings_total:
            type: Counter
            description: "Total number of warning logs"
            source: level
            config:
              match_all: true
              action: inc
            match_stage:
              selector: '{level="WARNING"}'

  # System logs scraping (optional)
  - job_name: system
    static_configs:
      - targets:
          - localhost
        labels:
          job: system
          __path__: /var/log/**/*.log

    pipeline_stages:
      - match:
          selector: '{job="system"}'
          stages:
            - regex:
                expression: '^(?P<timestamp>\S+\s+\S+)\s+(?P<hostname>\S+)\s+(?P<service>\S+?)(\[\d+\])?:\s+(?P<message>.*)$'
            - labels:
                service:
            - timestamp:
                source: timestamp
                format: "Jan 02 15:04:05"
                location: "Local"

  # Audit logs scraping (from audit log files if exported)
  - job_name: audit
    static_configs:
      - targets:
          - localhost
        labels:
          job: audit
          __path__: /var/log/biowerk/audit/**/*.log

    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            event_type: event_type
            user_id: user_id
            action: action
            resource: resource
            ip_address: ip_address
            severity: severity

      - timestamp:
          source: timestamp
          format: RFC3339Nano

      - labels:
          event_type:
          severity:
          action:

# Limits configuration
limits_config:
  readline_rate_enabled: true
  readline_rate: 10000  # lines per second
  readline_burst: 20000  # burst size
