# EAOS Handoff - 20260106_071348

## Scope

This handoff summarizes the current repo state, the recent work (by timestamped docs), and the most important risks and next steps. It is written for a trusted handoff between maintainers and matches the "nucleus moved out" direction.

## Timeline Of Recent Work (by timestamped files)

- 2025-12-28: `Ea_OS/DECISIONS_20251228_171652.md`
  - Locks the contract path: 8256-byte blob, 24-byte header (AAD), 8192-byte payload, 256-byte manifest.
  - Crypto decision: ChaCha20-Poly1305 + BLAKE3 (keyed), 24-byte nonce field retained for future XChaCha.
  - Notes open questions (nonce uniqueness, AArch64 endianness, trusted boot handoff).
- 2025-12-28: `Ea_OS/REVIEW_20251228_142032.md`
  - Confirms contract invariants and recommends wiring compiler/referee to deterministic vectors.
- 2025-12-29: `Ea_OS/GUIDE_20251229_142903.md`, `Ea_OS/STATUS_20251229_141039.md`, `Ea_OS/NOTE_20251229_142013.md`
  - Records removal of legacy referee crypto module; emphasizes v6 contract alignment and optional LLM profile.
- 2025-12-30: `EAOS_MASTER_SUMMARY_20251230_CZA.md`, deep dives (symbiote, ledger, contract, referee/nucleus, organelles)
  - Consolidates system description, v6 terminology, and the "nucleus moved out" preloader handoff.

## Current Boot Chain And Trust Boundary

**Stated flow in docs:**
`UEFI -> Referee -> Preloader -> Nucleus -> Symbiote -> other muscles`

**Actual code state:**
- Referee loads muscles from the bundle and executes them directly (`Ea_OS/referee/src/main.rs`).
- Preloader expects `BootParameters` in `x0` and verifies a nucleus blob by metadata, then branches to `nucleus_blob_addr + nucleus_entry_offset` (`Ea_OS/muscles/preloader/src/lib.rs`).
- There is no wiring in Referee to pass `BootParameters` to Preloader, and the Nucleus blob is not explicitly passed.

**Implication:**
The "trusted handoff" from Referee -> Preloader -> Nucleus is conceptually defined but not fully wired. This is the largest integration gap in the boot chain.

## "Nucleus Moved Out" Choice — Pros/Cons And Recommendation

**Option A: Embed Nucleus inside Preloader**
- Pros:
  - Fewer runtime parameters; no BootParameters struct to pass.
  - Simple integrity: one binary to verify.
  - Smaller surface for mis-wiring in early boot.
- Cons:
  - Preloader size grows fast (breaks the 2KiB budget).
  - Harder to update Nucleus independently.
  - Tightly couples Nucleus to the preloader build, limiting modularity.

**Option B: External Nucleus blob with Preloader handoff (current direction)**
- Pros:
  - Keeps preloader <= 2KiB, preserving minimal TCB.
  - Allows Nucleus to evolve without touching the preloader binary.
  - Matches the muscle contract model: Nucleus is a muscle blob.
- Cons:
  - Requires a robust handoff structure and clear trust chain.
  - Needs explicit hash/signature binding to prevent blob substitution.
  - Boot parameter ABI must be shared across Referee and Preloader.

**Recommendation (for prototype now, trusted handoff later):**
Stay with external Nucleus blob (Option B). It aligns with the architecture, keeps TCB small, and enables independent iteration. For a trusted handoff, wire `BootParameters` from Referee and set a pinned hash (or signature) for the nucleus blob in Preloader.

## What Changed Recently (Code + Docs)

### Boot Chain (Referee/Preloader)
- Preloader now expects external Nucleus blob metadata and can optionally pin a hash (`Ea_OS/muscles/preloader/src/lib.rs`).
- The preloader’s entry point restores the boot params before extracting the nucleus entry.

### Legacy Crypto
- Legacy referee crypto module removed (v6 contract is authoritative). This is consistent with the design/prototype phase.

### Docs Alignment
- Most documentation updated to v6, ChaCha20-Poly1305, and `EaKEYv6\0` master key header.

## Testing Status (as run)

Command run (offline due to restricted network):
`cargo test --offline -p ea-symbiote -p muscle-ea-pathfinder -p muscle-ea-neurowasm -p muscle-ea-axonwasm`

Results:
- `ea-symbiote`: builds, warnings only (unused imports in tests).
- `muscle-ea-pathfinder`: builds, warning for unused `fuel_remaining`.
- `muscle-ea-axonwasm`: build errors
  - `alloc::vec_deque` path is wrong; should be `alloc::collections::VecDeque`.
  - `hex` crate missing; used for lineage tag formatting.
  - `impl Trait` used in struct field; must be a named generic type.
- `muscle-ea-neurowasm`: build errors
  - `rand::rngs::OsRng` used without `rand`; should use `rand_core::OsRng` or add `rand`.
  - Orphan impl `impl From<MuscleError> for wasmtime::Error` is invalid.
  - Cache `get(&code_hash.into())` type inference fails; use `[u8; 32]` directly.
  - `pathfinder.execute` expects `Vec<u8>`, not `&[u8]`.
  - `MuscleError::InvalidOpcode` does not exist; use `MuscleError::Custom`.
  - Borrow errors in `execute` from holding `ctx.current_blob()` while mutably borrowing `ctx`.

## Immediate Gaps To Close (Trusted Handoff)

1. **Referee -> Preloader ABI**
   - Define and share `BootParameters` in a common crate or module.
   - Pass a pointer to `BootParameters` in `x0` when calling the preloader entry.
2. **Nucleus Blob Binding**
   - Set `EXPECTED_NUCLEUS_HASH` in the preloader for pinned builds, or
   - Extend the preloader to accept a signature (or reuse manifest hash) verified by Referee.
3. **Memory Map Clarity**
   - Document where the nucleus blob resides in RAM and who owns it (Referee vs UEFI).

## Next Steps (Practical Order)

1. Wire the `BootParameters` handoff in `Ea_OS/referee` and `Ea_OS/muscles/preloader`.
2. Fix axonwasm/neurowasm build errors (see Testing Status).
3. Re-run targeted tests after each fix set.
4. Decide on pinned hash or signed nucleus blob (for trusted handoff).

## Notes On Prototype Stage

- The current direction is explicitly prototype/design. Removing legacy crypto is fine and aligned with simplifying v6 alignment.
- The "trusted handoff" can be staged: wire the ABI first, then add pinned hash/signature.

## Key Files Referenced

- `Ea_OS/muscles/preloader/src/lib.rs`
- `Ea_OS/referee/src/main.rs`
- `Ea_OS/referee/src/muscle_loader.rs`
- `Ea_OS/docs/muscle-contract-v6.md`
- `Ea_OS/DECISIONS_20251228_171652.md`
