# FIX PLAN 2026-01-20

**Goal:** Restore workspace stability, complete Project Arachnid, and secure the Boot Chain.
**Context:** Several components (`muscle-ea-*`, `ledger-transport`) are failing to compile. Project Arachnid is in Phase 3 (Infrastructure) but incomplete. The Boot Chain lacks a trusted handoff.

---

## Phase 1: Stabilization (The "Healing")
*Priority: Critical. The workspace must build cleanly before new features are added.*

### 1.1 Fix `muscle-ea-axonwasm`
- **Issue:** Missing `hex` dependency, invalid `alloc` path, `impl Trait` return type issues.
- **Action:**
  - Add `hex = "0.4"` to `[dependencies]`.
  - Replace `alloc::vec_deque` with `alloc::collections::VecDeque`.
  - Refactor `impl Trait` return types to named generics or boxed types where necessary.

### 1.2 Fix `muscle-ea-neurowasm`
- **Issue:** Missing `rand`, invalid `wasmtime::Error` conversion (orphan rule), borrow checker violations in `execute`.
- **Action:**
  - Add `rand = "0.8"` (or `rand_core` with features) to `[dependencies]`.
  - Wrap `wasmtime::Error` in a local newtype or map it explicitly to `MuscleError`.
  - Fix borrow scope in `execute` (do not hold `ctx` borrow while mutating it).

### 1.3 Fix `muscle-ea-pathfinder`
- **Issue:** Missing dependencies and `wasmtime` API drift.
- **Action:**
  - Audit and add missing crates.
  - Update `wasmtime` calls to match version 24.0 API.

### 1.4 Fix `ledger-transport`
- **Issue:** API drift in `quinn`, `rustls`, and `tokio-stream`.
- **Action:**
  - Update `rustls` usage to match 0.23 provider API.
  - Ensure `tokio-stream` has `sync` feature enabled (already checked, possibly version mismatch).
  - Fix `quinn` endpoint configuration.

### 1.5 Fix `ea-symbiote`
- **Issue:** Integration test borrow error.
- **Action:**
  - Refactor test to avoid borrowing from temporary values.

---

## Phase 2: Project Arachnid Completion
*Priority: High. Finish the kernel-resident HTTP scraper.*

### 2.1 Finalize TCP Wiring
- **Action:** Complete the `smoltcp` socket connection logic in `muscles/referee-kernel/src/arachnid.rs`.
- **Details:** Ensure `poll_tcp` correctly handles the 3-way handshake and data streaming.

### 2.2 Shared Memory Ring Buffer
- **Action:** Verify `BIO-STREAM` ring buffer layout and QEMU shared memory integration.
- **Verification:** Write a test to ensure atomic head/tail updates work across the kernel/user boundary.

### 2.3 End-to-End Test
- **Action:** Validate full harvest loop: `Referee` -> `BIO-STREAM` -> `bio-bridge` -> `neon-systole`.

---

## Phase 3: Boot Chain Integrity (Trusted Handoff)
*Priority: High. Secure the Referee -> Preloader -> Nucleus path.*

### 3.1 BootParameters ABI
- **Action:** Define a `BootParameters` struct (C-compatible) shared between Referee and Preloader.
- **Path:** `common/boot_params.rs` (or similar).

### 3.2 Handoff Mechanism
- **Action:**
  - Update `referee` to pass `&BootParameters` in register `x0`.
  - Update `preloader` entry point to accept `x0` and restore context.

### 3.3 Nucleus Binding
- **Action:**
  - Calculate SHA-256 of `nucleus.blob`.
  - Pin this hash in `preloader`'s config.
  - Verify hash before jumping to Nucleus.

---

## Execution Order
1.  **Phase 1.1 - 1.5** (Build Fixes) -> `cargo test --workspace` MUST PASS.
2.  **Phase 2** (Arachnid) -> Functional feature.
3.  **Phase 3** (Boot Chain) -> Security hardening.
